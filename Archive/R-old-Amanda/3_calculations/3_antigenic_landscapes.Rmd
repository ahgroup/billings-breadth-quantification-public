---
title: "3_Antibody Landscapes"
author: "Amanda Skarlupka"
date: "`r Sys.Date()`"
output: html_document
---

#Purpose:

The purpose of this code is to create the models and figures for the antibody landscapes. The pairwise distances 

#Prerequisties:

Need to Run:

* ../code/1_cleaning/1_cleaning_code.R
* ../code/1_cleaning/2_pepitope_calculator.Rmd
* ../code/1_cleaning/3_acmap_creation.R
* ../code/1_cleaning/4_acmap_distances.Rmd

# Preparing the analysis:

## Load Packages
```{r setup, include=FALSE, warning = F}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F, error = F)
library(ggrepel) #repel
library(cowplot) #Plot grids
library(latex2exp) #Math expressions
library(tidyverse) #Working with data

source(here::here("R/functions/3_antigenic_landscapes.R")) #Contains the functions for creating linear models, result dataframes, and plots
#All warnings are suppressed because it's ggplot warnings about NAs for plot
```

## Cleaning Data

The data is filtered to remove 2020 season, individuals who did not have a titer increase, HAI results that didn't have a matching distance measurement, and the Type A influenza strains. The data only included the three distance measures: cartography, year, and p-epitope. 

Three different normalization schemes were used: season-based, strain-based, and vaccine-based. 
```{r data}

#Import the data:

data <- readRDS(file = here::here("data/processed/distance_data.rds")) %>%
  prepare_data(dataframe = .)

# Save cleaned files for potential future use with weighting:

  
saveRDS(object = data,
        file = here::here("data/processed/auc_data_typeA.rds"))


data_w <- data


plt_data <- data_w %>%
  dplyr::filter(distance_type == "Strain",
                vac_short == "H1N1:MI/15",
                dose == "SD") %>%
  tidyr::pivot_wider(names_from = distance_type,
                     values_from = distance_norm) %>%
  dplyr::rename(Original = distance,
                Normalized = Strain) %>%
  tidyr::pivot_longer(cols = c(Original, Normalized),
                      names_to = "distance_type",
                      values_to = "distance") %>%
  tidyr::pivot_longer(cols = c(prevactiter, postvactiter),
                   names_to = "timing",
                   values_to = "titer") %>%
  dplyr::mutate(timing = factor(timing, 
                                    levels = c("prevactiter", "postvactiter"), 
                                    labels = c("Pre-vaccination", "Post-vaccination")),
             distance_type = factor(distance_type, 
                                    levels = c("Original", "Normalized")),
             uniq_grouping = paste0(uniq_id, "--", timing))

data <- data %>%
  dplyr::select(-distance)

save_linear_models()

```

# Antigenic Landscapes

## Example of Normalization Requirement

upper and lower bounds of the linear regressions

```{r}
#Linear regressions for each individual
# Groups = unique id and timing, distance type == strain & distance and method

head(plt_data)
lm_df <- data.frame(group = character(),
                    slope = numeric(),
                    intercept = numeric(),
                    distance_max = numeric())
for (i in 1:length(unique(plt_data$uniq_grouping))) {
  x <- unique(plt_data$uniq_grouping)[i]
  mdl <- lm(titer ~ distance, data = subset(plt_data, 
                                            uniq_grouping == x & distance_type == "Original" & method == "Year"))
  lm_df[i,"slope"] <- mdl$coefficients[[2]]
  lm_df[i, "intercept"] <- mdl$coefficients[[1]]
  lm_df[i, "group"] <- x
  lm_df[i, "distance_max"] <- max(mdl$model$distance)
}

boundings <- lm_df %>%
  tidyr::separate(group, c("uniq_id", "timing"), sep = "--") %>%
  dplyr::group_by(timing) %>%
  dplyr::summarize(slope_mean = mean(slope),
            slope_sd = sd(slope),
            n = n(),
            min = 0,
            max = max(distance_max),
            slope_lwr = slope_mean - 1.96*slope_sd/sqrt(n),
            slope_upr = slope_mean + 1.96*slope_sd/sqrt(n),
            intercept_mean = mean(intercept),
            intercept_sd = sd(intercept),
            intercept_lwr = intercept_mean - 1.96*intercept_sd/sqrt(n),
            intercept_upr = intercept_mean + 1.96*intercept_sd/sqrt(n)
            ) %>%
  dplyr::mutate(titer_lwr = slope_lwr*max+intercept_lwr,
         titer_upr = slope_upr*max+intercept_upr,
         titer_mean = slope_mean*max+intercept_mean) %>%
#         titer_lu = slope_lwr*max+intercept_upr,
#         titer_ul = slope_upr*max+intercept_lwr) %>%
  tidyr::pivot_longer(cols = starts_with("titer"),
               names_to = "discard",
               values_to = "titer") %>%
  tidyr::pivot_longer(cols = c(intercept_lwr, intercept_upr, intercept_mean),
               names_to = "intercept_type",
               values_to = "intercept") %>%
  dplyr::select(-c(slope_sd, n, slope_lwr, slope_upr, intercept_sd)) %>%
  tidyr::separate(col = discard,
           sep = "_",
           into = c(NA, "titer_type")) %>%
  tidyr::separate(col = intercept_type,
           sep = "_",
           into = c(NA, "intercept_type")) %>%
  dplyr::filter(titer_type == intercept_type) %>%
  dplyr::select(-ends_with("type"))




```



```{r}
#plt_a <-  

  plt_data %>%
    dplyr::filter(distance_type == "Original",
                  method == "Year",
                  timing == "Pre-vaccination") %>%
      ggplot2::ggplot(aes(x = distance, 
                 y = titer,
                 color = timing,
                 fill = timing, #Distinguish timing by color/fill
                 linetype = timing)) + # Distinguish different doses by linetype
    ggplot2::geom_jitter(size = 1, shape = ".", width = 0)+  #Spreads out the points for readability. Only apply jitter in the Y-direction since the HAI titers are discrete and we don't want to apply jitter in the x-direction so as to not confuse the reader with regards to what the distance is
      ggplot2::geom_line(stat = "smooth", 
                         method = "lm",
                           aes(group = uniq_grouping),
                           se = FALSE,
                           alpha = 0.1) +
    #geom_smooth(method = "lm") +
    # Include the Linear regression best-fit line. Does not extend past the points used for linear regression
      #ggplot2::facet_wrap(vars(distance_type, method),
      #           ncol = 3,
      #           scales = 'free') + #Stratify by vaccine received (H1N1 and H3N2 component) and the distance calculation method
      ggplot2::ylab(latex2exp::TeX("$log_2$(HAI Titer)")) +
      ggplot2::xlab("Distance from Vaccine Strain") +
      ggplot2::labs(title = paste("H1N1: MI/15 (n = 521)\nOld method (purple) compared to new method (black)\nIndividual regressions (blue)"),
           color = "Timing",
           linetype = "Timing",
           fill = "Timing") +
      #ggplot2::scale_y_continuous(breaks = seq(0, 10, 2),
      #                   limits = c(0, 10))
      ggplot2::theme_bw()+
      #ggplot2::theme(legend.position = "bottom") +
      #ggplot2::guides(color = guide_legend(override.aes=list(fill=NA,
      ##                                              alpha = 1)),
      #       linetype = guide_legend(override.aes=list(fill = NA,
      #                                                 alpha = 1)),
      #       fill = "none") + # Only allow the line color/ type to be shown in the legend.
     ggplot2::scale_color_manual(values = c("Pre-vaccination" = "#56B4E9", "Post-vaccination" = "#E69F00")) + # Blue and Orange
      ggplot2::scale_fill_manual(values = c("Pre-vaccination" = "#56B4E9", "Post-vaccination" = "#E69F00")) +
ggplot2::geom_line(data = subset(plt_data, timing == "Pre-vaccination" & distance_type == "Original" & method == "Year"),
                           stat = "smooth",
                         method = "lm",
                         se = FALSE,
                         color = "#566be9",
                         linewidth = 1) +
   #   ggplot2::geom_line(data = subset(plt_data, timing == "Post-vaccination" & distance_type == "Original" & method == "Year"),
  #                        stat = "smooth",
  #                       method = "lm",
  #                       se = FALSE,
  #                       color = "#b37c00",
  #                       linewidth = 1.5) +
      ggplot2::geom_segment(data = boundings,
                       aes(x = 0,
                           xend = max,
                           y = intercept,
                           yend = titer,
                           group = timing,
                           linetype = timing),
                       color = "black",
                       linewidth = 1,
                       inherit.aes = FALSE)

```

```{r}
## Old version of the H3N2 figure, where the linear regression is from all of the points, not from individual regressions. Code can easily be switched to H1N1 or distance types
## H3N2
plt_b <-  data_w %>%
  dplyr::filter(distance_type == "Strain",
                vac_short == "H3N2:HK/14") %>%
  tidyr::pivot_wider(names_from = distance_type,
                     values_from = distance_norm) %>%
  dplyr::rename(Original = distance,
                Normalized = Strain) %>%
  tidyr::pivot_longer(cols = c(Original, Normalized),
                      names_to = "distance_type",
                      values_to = "distance") %>%
  tidyr::pivot_longer(cols = c(prevactiter, postvactiter),
                   names_to = "timing",
                   values_to = "titer") %>%
  dplyr::mutate(timing = factor(timing, 
                                levels = c("prevactiter", "postvactiter"), 
                                labels = c("Pre-vaccination", "Post-vaccination")),
             distance_type = factor(distance_type, 
                                    levels = c("Original", "Normalized"))) %>%
      ggplot2::ggplot(aes(x = distance, 
                 y = titer,
                 color = timing,
                 fill = timing, #Distinguish timing by color/fill
                 linetype = timing)) + # Distinguish different doses by linetype
      ggplot2::geom_jitter(size = 1, shape = ".", width = 0) + #Spreads out the points for readability. Only apply jitter in the Y-direction since the HAI titers are discrete and we don't want to apply jitter in the x-direction so as to not confuse the reader with regards to what the distance is
      ggplot2::geom_smooth(method = "lm") + # Include the Linear regression best-fit line. Does not extend past the points used for linear regression
      ggplot2::facet_wrap(vars(method, distance_type),
                 ncol = 2,
                 scales = 'free') + #Stratify by vaccine received (H1N1 and H3N2 component) and the distance calculation method
      ggplot2::ylab(latex2exp::TeX("$log_2$(HAI Titer)")) +
      ggplot2::xlab("Distance from Vaccine Strain") +
      ggplot2::labs(title = "H3N2: HK/14 (n = 583)",
           color = "Timing",
           linetype = "Timing") + 
      ggplot2::scale_y_continuous(breaks = seq(0, 10, 2),
                         limits = c(0, 10)) +
      ggplot2::theme_bw() +
      ggplot2::guides(color = guide_legend(override.aes=list(fill=NA,
                                                    alpha = 1)),
             linetype = guide_legend(override.aes=list(fill = NA,
                                                       alpha = 1)),
             fill = "none") + # Only allow the line color/ type to be shown in the legend.
      ggplot2::scale_color_manual(values = c("#56B4E9", "#E69F00")) + # Blue and Orange
      ggplot2::scale_fill_manual(values = c("#56B4E9", "#E69F00"))
plt_b
#cowplot::plot_grid(plt_a, plt_b,
#                   labels = "AUTO")

#cowplot::ggsave2(plot = plt_a, 
#        filename = here::here("results/figures/typeA_normalization.png"), 
#        scale = 1.5, 
#        width = 4,
#        height = 6)
```

Plot for manuscript
```{r}

manuscript_plt <- function(method_id, distance_type_id, xlab_id, legend_tf) {
  
  p <- plt_data %>%
  dplyr::filter(method == method_id, distance_type == distance_type_id) %>%
      ggplot2::ggplot(aes(x = distance, 
                 y = titer,
                 color = timing,
                 fill = timing, #Distinguish timing by color/fill
                 linetype = timing)) + # Distinguish different doses by linetype
      ggplot2::geom_jitter(size = 1, shape = ".", width = 0) + #Spreads out the points for readability. Only apply jitter in the Y-direction since the HAI titers are discrete and we don't want to apply jitter in the x-direction so as to not confuse the reader with regards to what the distance is
      ggplot2::geom_smooth(method = "lm") + # Include the Linear regression best-fit line. Does not extend past the points used for linear regression
     ggplot2:: ylab(latex2exp::TeX("$log_2$(HAI Titer)")) +
      ggplot2::xlab(paste(xlab_id)) +
      ggplot2::labs(color = "Timing",
           linetype = "Timing") + 
      ggplot2::scale_y_continuous(breaks = seq(0, 10, 2),
                         limits = c(0, 10)) +
      ggplot2::theme_bw()+
      ggplot2::theme(legend.position = legend_tf) +
      ggplot2::guides(color = guide_legend(override.aes=list(fill=NA,
                                                    alpha = 1)),
             linetype = guide_legend(override.aes=list(fill = NA,
                                                       alpha = 1)),
             fill = "none") + # Only allow the line color/ type to be shown in the legend.
      ggplot2::scale_color_manual(values = c("#56B4E9", "#E69F00")) + # Blue and Orange
      ggplot2::scale_fill_manual(values = c("#56B4E9", "#E69F00"))
  print(p)
}
plt_list <- vector(mode = "list")
plt_list[[1]] <- manuscript_plt("Year", "Original", "Years", "none")

plt_list[[2]] <- manuscript_plt("Year", "Normalized", "Normalized", "none")

plt_list[[3]] <- manuscript_plt("P-epitope", "Original", "P-epitope unit", "none")

plt_list[[4]] <- manuscript_plt("P-epitope", "Normalized", "Normalized", "none")

plt_list[[5]] <- manuscript_plt("Cartography", "Original", "Antigenic Unit (2-fold dilution in HAI)", "none")

plt_list[[6]] <- manuscript_plt("Cartography", "Normalized", "Normalized", "none")

suppressWarnings({cowplot::plot_grid(plotlist = plt_list,
                     byrow = FALSE,
                   ncol = 3,
                   labels = "AUTO") %>%
  cowplot::ggsave2(
        filename = here::here("results/figures/typeA_normalization.png"), 
        scale = 1.5, 
        width = 6,
        height = 4)})
```


## Individual

Individual example plot of antibody landscapes

```{r}
plt <- individual_plot(data,
                       individual_to_plot = 101)
  
cowplot::ggsave2(plot = plt, 
        filename = here::here("results/figures/typeA_sd_individual.png"), 
        scale = 1.5, 
        width = 6,
        height = 4)

```




Create the different linear regression models. The linear regression models are by the normalization scheme, the outcome of interest, and the different dataset filtering (SD only and SD/HD comparison).

```{r mdl-datasets}

antibody_landscapes()


```
Figures for manuscript:

```{r}
location <- "data/processed/linear_regression_models/"
save_with_labels <- TRUE

mdl_list <- readRDS(file = here::here(paste0(location, "mdl_list.rds")))
slope_list <- readRDS(file = here::here(paste0(location, "slope_list.rds")))


#Start Figure building
  dataframe <- data
  strain_to_plot <- c("H1N1:CA/09", "H3N2:HK/14")
  mdl_to_use <- "Strain prepost SD"
  mdl <- mdl_list
  slopes <- slope_list
  
  # Create the variables 
  variables <- base::strsplit(mdl_to_use,
                        split = " ")[[1]]
  
  normalization <- variables[1]
  outcome <- variables[2]
  dose <- variables[3]
  
  # Reduce the lists to the important ones
  mdl <- mdl[[mdl_to_use]] %>%
    dplyr::filter(vac_short %in% strain_to_plot) %>%
    dplyr::mutate(dose_label = paste0(vac_short, "\n", dose_label)) %>%
    base::droplevels()
  
  slopes <- slopes[[mdl_to_use]] %>%
    dplyr::filter(vac_short %in% strain_to_plot) %>%
    base::droplevels()
  
  # Reduce the dataframe to the SD only or the >= 65 age only. 
  
    dataframe <- dataframe %>%
      dplyr::filter(distance_type == normalization, #Select the distance normalization
                    vac_short %in% strain_to_plot) %>% #Select the strain to be plotted
      {
        if (dose == "SD") { #If SD need to remove all individuals who did not receive SD
          dplyr::filter(.data = ., dose == "SD") 
        } else if (dose == "SDHD") { #If SDHD need to remove all non elderly individuals
          dplyr::filter(.data = ., age >= 65)
        } else { #Produce a warning if the dose does not match
            stop(paste(dose, ": Not found. Only the SD only individuals all ages, and the SD HD individuals of 65+ years are to be analyzed using this code.")) 
                 }
        } %>%
      base::droplevels() %>%
      dplyr::group_by(dose, vac_short) %>% # Add sample size labels to the corresponding dose for the legends
            mutate(dose_label = paste0("(n=", dplyr::n_distinct(uniq_id), ")")) %>% # Total number of people in the dose 
      {
        if (dose == "SD") {
          dplyr::mutate(.data = .,
                        dose_label = forcats::fct_cross(dose, 
                                                        dose_label, 
                                                        sep = " "),
                        dose_label = paste0(vac_short, "\n", dose_label)) #Combine it with the dose
        } else if (dose == "SDHD") {
          dplyr::mutate(.data = .,
                        dose_label = forcats::fct_cross(dose, 
                                                        dose_label, 
                                                        sep = " ")) %>%
          dplyr::group_by(vac_short) %>%
            dplyr::arrange(dose) %>%
            dplyr::mutate(dose_label = paste(unique(dose_label), 
                                             collapse = " | "))
        }
      } %>%
    dplyr::ungroup() %>%
      base::droplevels()
  
  # Plot the prepost after pivoting and relabeling. Usually this plot is only for the standard dose only comparison. Not the HD/SD. 
  
  #Prepost plot  
    plt <-  dataframe %>%
      tidyr::pivot_longer(cols = c(prevactiter, postvactiter),
                   names_to = "timing",
                   values_to = "titer") %>%
      dplyr::mutate(timing = factor(timing, 
                                    levels = c("prevactiter", "postvactiter"), 
                                    labels = c("Pre-vaccination", "Post-vaccination"))) %>%
      ggplot2::ggplot(aes(x = distance_norm, 
                 y = titer,
                 color = timing, #Distinguish timing by color/fill
                 fill = timing,
                 linetype = timing)) + # Distinguish different doses by linetype
      ggplot2::geom_jitter(size = 1, shape = ".", width = 0)  + #Spreads out the points for readability. Only apply jitter in the Y-direction since the HAI titers are discrete and we don't want to apply jitter in the x-direction so as to not confuse the reader with regards to what the distance is
      ggplot2::geom_line(data = mdl,
                aes(x = pred,
                    y = slope*pred+intercept,
                    color = timing)) +
      ggplot2::geom_ribbon(data = mdl,
                  aes(x = pred,
                      y = pred*slope+intercept,
                      ymax = conf_upr95,
                      ymin = conf_lwr95,
                      linetype = timing),
                  alpha = 0.5,
                  color = NA) + # Include the 95% se confidence intervals of the models. do not include bounding lines
      ggplot2::facet_grid(rows = vars(dose_label),
                 cols = vars(method)) + #Stratify by the distance calculation method
      ggplot2::ylab(latex2exp::TeX("$log_2$(HAI Titer)")) +
      ggplot2::xlab("Distance from Vaccine Strain") +
      ggplot2::labs(title = NULL,
           color = "Timing",
           fill = "Timing",
           linetype = "Timing") +
      ggplot2::scale_y_continuous(breaks = seq(0, 10, 2),
                         limits = c(0, 10)) +
      ggplot2::theme_bw()+
      ggplot2::theme(legend.position = "bottom") +
        ggplot2::guides(color = guide_legend(override.aes=list(fill=NA,
                                                      alpha = 1)),
               fill = "none") + # Only allow the line color/ type to be shown in the legend.
        ggplot2::scale_color_manual(values = c("#56B4E9", "#E69F00")) + # Blue and Orange
        ggplot2::scale_fill_manual(values = c("#56B4E9", "#E69F00")) # Blue and Orange
  
if (save_with_labels == TRUE) {
  strain_dataframe <- dataframe %>%
    dplyr::select(vac_short, dose_label) %>%
    dplyr::distinct() %>%
    base::droplevels() 
  
  labels <- data %>%
  dplyr::select(vac_short, strain_short, method, distance_norm, distance_type) %>%
    dplyr::left_join(strain_dataframe,
                     by = "vac_short") %>%
  dplyr::filter(vac_short %in% strain_to_plot,
         distance_type == "Strain",
    strain_short %in% c("CA/09", "NC/99", "SC/18", "HK/14", "Shan/93", "TX/77")) %>%
  dplyr::distinct() %>%
    base::droplevels()
  
  plt <- plt +
    ggrepel::geom_label_repel(data = labels,
            aes(x = distance_norm,
                y = 0,
                label = strain_short),
            min.segment.length = unit(0, 'lines'),
            color = "black",
            inherit.aes = FALSE,
            size = 3,
            box.padding = 0.1) +
    ggplot2::labs(title = NULL)
}
  
  cowplot::ggsave2(filename = here::here("results/figures/strain_CA09HK14_prepost.png"),
                   plot = plt,
                   width = 6,
                   height = 5)
    
#For the SDHD it is very cluttered having the vaccine strains and the 3 different measures so create a list that contains each individual strain stratified by subset and method. This is to compare if the different subsets gave similar comparisons within the same strain
 
    mdl_to_use <- "Strain titerincrease SD"
  mdl <- mdl_list
  slopes <- slope_list
  
  # Create the variables 
  variables <- base::strsplit(mdl_to_use,
                        split = " ")[[1]]
  
  normalization <- variables[1]
  outcome <- variables[2]
  dose <- variables[3]
  
  # Reduce the lists to the important ones
  mdl <- mdl[[mdl_to_use]] %>%
    dplyr::filter(vac_short %in% strain_to_plot) %>%
    dplyr::mutate(dose_label = paste0(vac_short, "\n", dose_label)) %>%
    base::droplevels()
  
  slopes <- slopes[[mdl_to_use]] %>%
    dplyr::filter(vac_short %in% strain_to_plot) %>%
    base::droplevels()
  
  #titerincrease plot   
      plt <- dataframe %>%
        ggplot2::ggplot(aes(x = distance_norm, 
                            y = titerincrease)) +
        ggplot2::geom_jitter(size = 1, shape = ".", width = 0) +
        ggplot2::geom_line(data = mdl,
                  aes(x = pred,
                      y = slope*pred+intercept)) +
        ggplot2::geom_ribbon(data = mdl,
                    aes(x = pred,
                        y = pred*slope+intercept,
                        ymax = conf_upr95,
                        ymin = conf_lwr95),
                    alpha = 0.5,
                    color = NA) + 
        ggplot2::facet_grid(rows = vars(dose_label), 
                   cols = vars(method)) +
        ggplot2::ylab(latex2exp::TeX("$log_2$(HAI Titer) Increase")) +
        ggplot2::xlab("Distance from Vaccine Strain")  +
        ggplot2::scale_y_continuous(breaks = seq(-1, 4, 1),
                           limits = c(-1, 4)) +
        ggplot2::theme_bw()+
        ggplot2::geom_hline(yintercept = 0,
                   linetype = "dashed") +
        ggplot2::theme(legend.position = "bottom") +
        ggplot2::guides(color = guide_legend(override.aes=list(fill=NA,
                                                      alpha = 1)),
               fill = "none")# + # Only allow the line color/ type to be shown in the legend.
        #scale_color_manual(values = c("#56B4E9", "#E69F00")) + # Blue and Orange
        #scale_fill_manual(values = c("#56B4E9", "#E69F00"))

      cowplot::ggsave2(filename = here::here("results/figures/strain_CA09HK14_titerincrease.png"),
                   plot = plt,
                   width = 6,
                   height = 5)

  


```

```{r titerincrease-dose}
location <- "data/processed/linear_regression_models/"
save_with_labels <- FALSE

mdl_list <- readRDS(file = here::here(paste0(location, "mdl_list.rds")))
slope_list <- readRDS(file = here::here(paste0(location, "slope_list.rds")))


#Start Figure building
  dataframe <- data
  strain_to_plot <- c("H1N1:CA/09", "H3N2:HK/14")
  mdl_to_use <- "Strain titerincrease SDHD"
  mdl2 <- mdl_list
  slopes <- slope_list
  
  # Create the variables 
  variables <- base::strsplit(mdl_to_use,
                        split = " ")[[1]]
  
  normalization <- variables[1]
  outcome <- variables[2]
  dose <- variables[3]
  
  # Reduce the lists to the important ones
  mdl <- mdl2[[mdl_to_use]] %>%
    dplyr::filter(vac_short %in% strain_to_plot) %>%
    tidyr::pivot_wider(names_from = dose, values_from = dose_label) %>%
    dplyr::group_by(vac_short) %>%
    dplyr::mutate(SD2 = SD,
                  HD2 = HD) %>%
    tidyr::fill(data = ., c(SD2, HD2), .direction = 'downup') %>%
    dplyr::ungroup() %>%
    dplyr::mutate(dose_label = paste(SD2, HD2, sep = " | ")) %>%
        dplyr::select(-c(SD2, HD2)) %>%
    tidyr::pivot_longer(cols = c(SD, HD),
                        names_to = "dose",
                        values_to = "drop") %>%
    #dplyr::select(-drop) %>%
    dplyr::filter(!is.na(drop)) %>%
    dplyr::mutate(dose = factor(dose, levels = c("SD", "HD")))
```

```{r}
  slopes <- slopes[[mdl_to_use]] %>%
    dplyr::filter(vac_short %in% strain_to_plot) %>%
    base::droplevels()
  
  # Reduce the dataframe to the SD only or the >= 65 age only. 
    
    d2 <- dataframe %>%
      dplyr::filter(distance_type == normalization, #Select the distance normalization
                    vac_short %in% strain_to_plot) %>% #Select the strain to be plotted
     # {
    #    if (dose == "SD") { #If SD need to remove all individuals who did not receive SD
    #      dplyr::filter(.data = ., dose == "SD") 
    #    } else if (dose == "SDHD") { #If SDHD need to remove all non elderly individuals
          dplyr::filter(.data = ., age >= 65) %>%
     #   } else { #Produce a warning if the dose does not match
      #      stop(paste(dose, ": Not found. Only the SD only individuals all ages, and the SD HD individuals of 65+ years are to be analyzed using this code.")) 
       #          }
       # } %>%
      base::droplevels() %>%
      dplyr::group_by(dose, vac_short) %>% # Add sample size labels to the corresponding dose for the legends
            dplyr::mutate(dose_label = paste0("(n=", n_distinct(uniq_id), ")")) %>% # Total number of people in the dose 
      #{
      #  if (dose == "SD") {
      #    dplyr::mutate(.data = .,
      #                  dose_label = forcats::fct_cross(dose, dose_label, sep = " "),
      #                  dose_label = paste0(vac_short, "\n", dose_label)) #Combine it with the dose
      #  } else if (dose == "SDHD") {
            dplyr::mutate(.data = .,
                          dose_label = paste0(dose, " ", dose_label)) %>%
            tidyr::pivot_wider(names_from = dose, 
                               values_from = dose_label) %>%
            dplyr::group_by(vac_short) %>%
            dplyr::mutate(SD2 = SD,
                          HD2 = HD) %>%
            tidyr::fill(data = ., c(SD2, HD2), .direction = 'downup') %>%
            dplyr::ungroup() %>%
            dplyr::mutate(dose_label = paste(SD2, HD2, sep = " | ")) %>%
                dplyr::select(-c(SD2, HD2)) %>%
            tidyr::pivot_longer(cols = c(SD, HD),
                                names_to = "dose",
                                values_to = "drop") %>%
           # dplyr::select(-drop) %>%
      dplyr::filter(!is.na(drop)) %>%
     #   }
    #  } %>%
    dplyr::ungroup() %>%
      base::droplevels() %>%
      dplyr::mutate(dose = factor(dose, levels = c("SD", "HD")))
  
  
  #titerincrease plot   
      plt <- d2 %>%
        ggplot2::ggplot(aes(x = distance_norm, 
                            y = titerincrease,
                            linetype = dose,
                            color = dose)) +
        ggplot2::geom_jitter(size = 1, shape = ".", width = 0) +
        ggplot2::geom_line(data = mdl,
                  aes(x = pred,
                      y = slope*pred+intercept,
                      color = dose)) +
        ggplot2::geom_ribbon(data = mdl,
                    aes(x = pred,
                        y = pred*slope+intercept,
                        ymax = conf_upr95,
                        ymin = conf_lwr95,
                        fill = dose),
                    alpha = 0.5,
                    color = NA) + 
        ggplot2::facet_grid(rows = vars(vac_short, dose_label), 
                   cols = vars(method)) +
        ggplot2::ylab(latex2exp::TeX("$log_2$(HAI Titer) Increase")) +
        ggplot2::xlab("Distance from Vaccine Strain")  +
        ggplot2::labs(color = "Dose",
             linetype = "Dose") +
        ggplot2::scale_y_continuous(breaks = seq(-1, 4, 1),
                           limits = c(-1, 4)) +
        ggplot2::theme_bw()+
        ggplot2::geom_hline(yintercept = 0,
                   linetype = "dashed") +
        ggplot2::theme(legend.position = "bottom") +
        ggplot2::guides(color = guide_legend(override.aes=list(fill=NA,
                                                      alpha = 1)),
               fill = "none") + # Only allow the line color/ type to be shown in the legend.
        ggplot2::scale_color_manual(values = c("#46008B", "#468B00")) + # Navy and Dark Red
      ggplot2::scale_fill_manual(values = c("#46008B", "#468B00")) # Navy and Dark Red

      cowplot::ggsave2(filename = here::here("results/figures/strain_CA09HK14_titerincrease_dose.png"),
                   plot = plt,
                   width = 6,
                   height = 5)



```


```{r supp-season-prepost}
location <- "data/processed/linear_regression_models/"
save_with_labels <- TRUE

mdl_list <- readRDS(file = here::here(paste0(location, "mdl_list.rds")))
slope_list <- readRDS(file = here::here(paste0(location, "slope_list.rds")))
sample_size_list <- readRDS(file = here::here(paste0(location, "size_list.rds")))

for (j in c("SD")) {
  
plt_list <- vector(mode = "list")

for (i in 2014:2019) {
  x <- paste0("season_", i)
  
  plt_list[[x]] <- season_plots(dataframe = data,
                                season_to_plot = i,
                                mdl_to_use = paste0("Season prepost ", j),
                                mdl = mdl_list,
                                slopes = slope_list,
                                sample_size = sample_size_list,
                                include_equation_label = FALSE)
}


cowplot::plot_grid(plotlist = plt_list,
                   nrow = 3,
                   ncol = 2,
                   labels = "AUTO"
                   ) %>%
  cowplot::ggsave2(filename = here::here(paste0("results/figures/typeA_", tolower(j), "_prepost_season.png")), 
                   width = 12,
                   height = 15)
  
#  if (save_with_labels == TRUE) {
  
#  labels <- data %>%
#  select(season, vac_short, strain_short, method, distance_norm, distance_type) %>%
#  filter(season == 2017,
#distance_type == "Season",
#    strain_short %in% c("NC/99", "USSR/77", "SC/18", "Shan/93", "TX/77", "Vic/11")) %>%
#  distinct() %>%
#    droplevels()
#  
##  plt <- plt_list[["season_2017"]] +
#    geom_label_repel(data = labels,
#            aes(x = distance_norm,
#                y = 0,
#                label = strain_short),
#            color = "black",
#            inherit.aes = FALSE,
#            size = 1.5,
#            direction = "y",
#            box.padding = 0.1) +
#    labs(title = NULL)
  
  
#  cowplot::ggsave2(filename = here::here(paste0("results/figures/typeA_", tolower(j), #"_prepost_season17_season.png")),
#                   plot = plt,
#                   width = 6,
#                   height = 5)


  
}

```



```{r supp-season-titerincrease}

for (j in c("SD")) {
  
plt_list <- vector(mode = "list")

for (i in 2014:2019) {
  x <- paste0("season_", i)
  
  plt_list[[x]] <- season_plots(dataframe = data,
                                season_to_plot = i,
                                mdl_to_use = paste0("Season titerincrease ", j),
                                mdl = mdl_list,
                                slopes = slope_list,
                                sample_size = sample_size_list,
                                include_equation_label = FALSE)
}



cowplot::plot_grid(plotlist = plt_list,
                   nrow = 3,
                   ncol = 2,
                   labels = "AUTO"
                   ) %>%
  cowplot::ggsave2(filename = here::here(paste0("results/figures/typeA_", tolower(j), "_titerincrease_season.png")), 
                   width = 12,
                   height = 15)
  
#  if (save_with_labels == TRUE) {
  
#  labels <- data %>%
#  select(season, vac_short, strain_short, method, distance_norm, distance_type) %>%
#  filter(season == 2017,
#distance_type == "Season",
#    strain_short %in% c("NC/99", "USSR/77", "SC/18", "Shan/93", "TX/77", "Vic/11")) %>%
#  distinct() %>%
#    droplevels()
#  
##  plt <- plt_list[["season_2017"]] +
#    geom_label_repel(data = labels,
#            aes(x = distance_norm,
#                y = 0,
#                label = strain_short),
#            color = "black",
#            inherit.aes = FALSE,
#            size = 1.5,
#            direction = "y",
#            box.padding = 0.1) +
#    labs(title = NULL)
  
  
#  cowplot::ggsave2(filename = here::here(paste0("results/figures/typeA_", tolower(j), #"_prepost_season17_season.png")),
#                   plot = plt,
#                   width = 6,
#                   height = 5)


  } 


```


```{r supp-vaccine-titerincrease}

for (j in c("SD")) {
  
plt_list <- vector(mode = "list")

for (i in 2014:2019) {
  x <- paste0("season_", i)
  
  plt_list[[x]] <- season_plots(dataframe = data,
                                season_to_plot = i,
                                mdl_to_use = paste0("Vaccine titerincrease ", j),
                                mdl = mdl_list,
                                slopes = slope_list,
                                sample_size = sample_size_list,
                                include_equation_label = FALSE)
}


cowplot::plot_grid(plotlist = plt_list,
                   nrow = 3,
                   ncol = 2,
                   labels = "AUTO"
                   ) %>%
  cowplot::ggsave2(filename = here::here(paste0("results/figures/typeA_", base::tolower(j), "_titerincrease_vaccine.png")), 
                   width = 12,
                   height = 15)
}

```


```{r supp-strain-prepost}
plt_list <- vector(mode = "list")
for (i in c("H1N1", "H3N2")) {
  plt_list[[i]] <- subtype_plots(dataframe = data,
               subtype_to_plot = i,
               mdl_to_use = "Strain prepost SD")
}


  
cowplot::plot_grid(plotlist = plt_list,
                   nrow = 2,
                   ncol = 1,
                   rel_heights = c(3, 5),
                   labels = "AUTO"
                   ) %>%
  cowplot::ggsave2(filename = here::here("results/figures/typeA_sd_prepost_strain.png"), 
                   width = 6,
                   height = 15)

```




```{r supp-strain-titerincrease}
plt_list <- vector(mode = "list")
for (i in c("H1N1", "H3N2")) {
  plt_list[[i]] <- subtype_plots(dataframe = data,
               subtype_to_plot = i,
               mdl_to_use = "Strain titerincrease SD")
}

  
cowplot::plot_grid(plotlist = plt_list,
                   nrow = 2,
                   ncol = 1,
                   rel_heights = c(3, 5),
                   labels = "AUTO"
                   ) %>%
  cowplot::ggsave2(filename = here::here("results/figures/typeA_sd_titerincrease_strain.png"), 
                   width = 6,
                   height = 15)

```
