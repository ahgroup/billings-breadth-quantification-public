---
title: "H1N1 Antigenic Map Analysis"
author: "Amanda Skarlupka"
date: "01/26/2022"
output: html_document
---

#Purpose:

#Prerequisites:

Need to run first:

* ~../1_cleaning/1_cleaning_code.Rmd

# Products:

This file needs to be ran before:
* the dimension selection can be done on the GACRC. 
* ../1_cleaning/3_acmap_distances.Rmd

Creates files for dimension selection for H1 for:

* Pretiter (all and only Standard dose)
* Posttiter (all and only standard dose)

Plot Acmaps for:

* 1-3 dimensions
* All and standard dose datasets
* Pre and Posttiter HAIs

Creates figures for:

*Standard dose 2D and 3D antigenic maps with and without sera (RDS file for 3d maps)
*Comparison figures of the 2D pre and post vaccination


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Racmacs) #Calculating antigenic distance and creating maps
library(ggrepel)
library(tidyverse) #Working with data
source(here::here("R/functions/antigenic-cartography.R"))

subtype <- "h1"
```

Read in the data

```{r data}
key <- readRDS(file = here::here("data/processed/clean_data.rds")) %>%
  dplyr::select(uniq_id, season, age, dose, h1n1_vaccine_fullname, titerincrease, strains_fullname) %>%
  dplyr::filter(paste(strains_fullname) == paste(h1n1_vaccine_fullname)) %>%
  dplyr::distinct()

virus <- readRDS(file = here::here("data/processed/virus_info.rds"))
```

# Visualizing the Standard Dose Maps


## Pre Vaccination

Using the two dimension all vaccine dataset, plot the maps of the H1N1 
```{r 2d-antigen}

map <- Racmacs::read.acmap(filename = here::here(paste0("data/processed/",
                                               subtype, 
                                               "_maps/", 
                                               subtype, 
                                               "_pre_sd_2d.ace")))
                    
map_df <- AcmapToDF(map,
                    MergeWithKey = TRUE,
                    key)

map_pre <- map_df

antigen_map <- map_df %>%
    dplyr::filter(type == "antigen") %>%
  dplyr::select(c("V1", "V2", "identifier", "type")) %>%
    dplyr::left_join(virus, 
              by = c("identifier" = "analysis_name")) %>%
  ggplot2::ggplot(aes(x = V1, 
             y = V2, 
             label = short_name)) +
      ggplot2::geom_point() +
      ggrepel::geom_label_repel(size = 3) +
      ggplot2::labs(title = "H1N1 virus antigenic map with pre-vaccination sera from all individuals", 
           subtitle = paste0("Stress = ", round(map$optimizations[[1]]$stress[1], digits = 2)),
           caption = "2 dimensions; 100 optimizations\nUnderconstrained sera and antigens were removed prior to map creation\nStandard dose individuals only") +
     ggplot2::xlab("Antigenic Distance Unit") +
      ggplot2::ylab("Antigenic Distance Unit") +
  ggplot2::theme_bw() +
    ggplot2::xlim(c(-3.5, 2)) +
    ggplot2::ylim(c(-3.5, 2))

```

```{r 2d-sera-antigen}

(pre_sr_ag <- map_df %>%
  dplyr::filter(type == "antigen") %>%
      dplyr::left_join(virus, 
              by = c("identifier" = "analysis_name")) %>%
  ggplot2::ggplot() +
      ggplot2::geom_point(data = subset(map_df, 
                               type == "sera"), 
                 aes(x = V1, 
                     y = V2,
                     color = age)) +
      ggplot2::geom_point(aes(x = V1, 
                     y = V2),
                 color = "red") +
      ggrepel::geom_label_repel(aes(x = V1, y = V2, label = short_name), max.overlaps = 17, size = 2.5) +
      ggplot2::labs(title = "H1N1 virus and human sera antigenic map\nwith pre-vaccination sera from all individuals", 
           subtitle = paste0("Stress = ", round(map$optimizations[[1]]$stress[1], digits = 2)),
           caption = "2 dimensions; 100 optimizations\nUnderconstrained sera and antigens were removed prior to map creation\nStandard dose individuals only") +
      ggplot2::xlab("Antigenic Distance Unit") +
      ggplot2::ylab("Antigenic Distance Unit") +
      ggplot2::xlim(c(-8, 5.5)) +
      ggplot2::ylim(c(-5.5, 5.5)))

```

## Post Vaccination

```{r 2d-antigen}

map <- Racmacs::realignMap(map = Racmacs::read.acmap(filename = here::here(paste0("data/processed/", 
                                                                   subtype, 
                                                                   "_maps/", 
                                                                   subtype, 
                                                                   "_post_sd_2d.ace"))),
                           target_map = Racmacs::read.acmap(filename = here::here(paste0("data/processed/", 
                                                                   subtype, 
                                                                   "_maps/", 
                                                                   subtype, 
                                                                   "_pre_sd_2d.ace"))))

map_df <- AcmapToDF(map, MergeWithKey = TRUE, key)

map_post <- map_df

antigen_map <- map_df %>%
  dplyr::select("V1", "V2", "identifier", "type") %>%
    dplyr::filter(type == "antigen") %>%
          dplyr::left_join(virus, 
              by = c("identifier" = "analysis_name")) %>%
  ggplot2::ggplot(aes(x = V1, 
             y = V2, 
             label = short_name)) +
      ggplot2::geom_point() +
      ggrepel::geom_label_repel(size = 3,
                       alpha = 0.75) +
  ggplot2::theme_bw()+
      ggplot2::labs(title = "H1N1", 
           caption = paste0("Stress = ", round(map$optimizations[[1]]$stress[1], digits = 2))) +
      ggplot2::xlab("Antigenic Distance Unit") +
      ggplot2::ylab("Antigenic Distance Unit") # +
  #ggplot2::scale_y_continuous(breaks=seq(-3, 3 ,1),
                     #limits = c(-3, 3)) +
  #ggplot2::scale_x_continuous(breaks=seq(-4, 1 ,1),
                     #limits = c(-4.5, 1.5))

saveRDS(antigen_map,
        file = here::here('data/processed/h1_maps/h1_cartography.rds'))

ggsave(filename = here::here(paste0("Results/Figures/", 
                                    subtype, 
                                    "/", 
                                    subtype, 
                                    "_post_sd_2d_antigens.png")), 
       plot = antigen_map, 
       width = 6)
  
```

```{r}
base::subset(map_post, 
       type == "antigen") %>%
  dplyr::left_join(subset(map_pre,
                   type == "antigen"),
            by = "identifier") %>%
  dplyr::select(V1.x, V2.x, identifier, V1.y, V2.y) %>%
  ggplot2::ggplot(aes(x = V1.y, y = V2.y))+
  ggplot2::geom_point() +
  ggplot2::geom_segment(aes(xend = V1.x, yend = V2.x),
               arrow = arrow())

b <- Racmacs::procrustesMap(comparison_map = Racmacs::read.acmap(filename = here::here(paste0("data/processed/", 
                                                                   subtype, 
                                                                   "_maps/", 
                                                                   subtype, 
                                                                   "_post_sd_2d.ace"))),
                           map = Racmacs::read.acmap(filename = here::here(paste0("data/processed/", 
                                                                   subtype, 
                                                                   "_maps/", 
                                                                   subtype, 
                                                                   "_pre_sd_2d.ace"))),
                           sera = FALSE)

tibble::as_tibble(b$optimizations[[1]]$procrustes$ag_coords) %>%
  ggplot2::ggplot(aes(x = V1, y = V2)) +
  ggplot2::geom_point()

a <- Racmacs::procrustesData(map = Racmacs::read.acmap(filename = here::here(paste0("data/processed/", 
                                                                   subtype, 
                                                                   "_maps/", 
                                                                   subtype, 
                                                                   "_post_sd_2d.ace"))),
                           comparison_map = Racmacs::read.acmap(filename = here::here(paste0("data/processed/", 
                                                                   subtype, 
                                                                   "_maps/", 
                                                                   subtype, 
                                                                   "_pre_sd_2d.ace"))))
```


```{r 2d-sera-antigen}

(post_sr_ag <- map_df %>%
  dplyr::filter(type == "antigen") %>%
      dplyr::left_join(virus, 
              by = c("identifier" = "analysis_name")) %>%
  ggplot2::ggplot() +
      ggplot2::geom_point(data = subset(map_df, 
                               type == "sera"), 
                 aes(x = V1, 
                     y = V2,
                     color = age)) +
      ggplot2::geom_point(aes(x = V1, 
                     y = V2),
                 color = "red") +
      ggrepel::geom_label_repel(aes(x = V1, y = V2, label = short_name), max.overlaps = 17, size = 2.5) +
      ggplot2::labs(title = "H1N1 virus and human sera antigenic map\nwith post-vaccination sera from all individuals", 
           subtitle = paste0("Stress = ", round(map$optimizations[[1]]$stress[1], digits = 2)),
           caption = "2 dimensions; 100 optimizations\nUnderconstrained sera and antigens were removed prior to map creation\nStandard dose individuals only") +
      ggplot2::xlab("Antigenic Distance Unit") +
      ggplot2::ylab("Antigenic Distance Unit") +
      ggplot2::xlim(c(-8, 5.5)) +
      ggplot2::ylim(c(-5.5, 5.5)))


  ggsave(filename = here::here(paste0("Results/figures/", 
                                      subtype, 
                                      "/", 
                                      subtype, 
                                      "_post_sd_2d_antigen_sera.png")), 
         plot = post_sr_ag, 
         width = 11)

  cowplot::plot_grid(pre_sr_ag, 
                     post_sr_ag, 
                     nrow = 1) %>%
  cowplot::ggsave2(filename = here::here(paste0("Results/figures/", 
                                                subtype, 
                                                "/", 
                                                subtype, 
                                                "_comp_sd_2d_antigen_sera.png")), 
                   width = 12, 
                   height = 6)

```

#H3
```{r}
subtype <- "h3"
```

Read in the data

```{r data}
key <- readRDS(file = here::here("data/processed/clean_data.rds")) %>%
  dplyr::select(uniq_id, season, age, dose, h3n2_vaccine_fullname, titerincrease, strains_fullname) %>%
  dplyr::filter(paste(strains_fullname) == paste(h3n2_vaccine_fullname)) %>%
  dplyr::distinct()

virus <- readRDS(file = here::here("data/processed/virus_info.rds"))
```

# Visualizing the Standard Dose Maps


## Pre Vaccination

Using the two dimension all vaccine dataset, plot the maps of the H1N1 
```{r 2d-antigen}

map <- Racmacs::read.acmap(filename = here::here(paste0("data/processed/",
                                               subtype, 
                                               "_maps/", 
                                               subtype, 
                                               "_pre_sd_2d.ace")))
                    
map_df <- AcmapToDF(map,
                    MergeWithKey = TRUE,
                    key)

map_pre <- map_df

antigen_map <- map_df %>%
    dplyr::filter(type == "antigen") %>%
  dplyr::select(c("V1", "V2", "identifier", "type")) %>%
    dplyr::left_join(virus, 
              by = c("identifier" = "analysis_name")) %>%
  ggplot2::ggplot(aes(x = V1, 
             y = V2, 
             label = short_name)) +
      ggplot2::geom_point() +
      ggrepel::geom_label_repel(size = 3) +
      ggplot2::labs(title = "H3N2 virus antigenic map with pre-vaccination sera from all individuals", 
           subtitle = paste0("Stress = ", round(map$optimizations[[1]]$stress[1], digits = 2)),
           caption = "2 dimensions; 100 optimizations\nUnderconstrained sera and antigens were removed prior to map creation\nStandard dose individuals only") +
     ggplot2::xlab("Antigenic Distance Unit") +
      ggplot2::ylab("Antigenic Distance Unit") +
  ggplot2::theme_bw() +
    ggplot2::xlim(c(-5, 3)) +
    ggplot2::ylim(c(-1, 3.5))

```

```{r 2d-sera-antigen}

pre_sr_ag <- map_df %>%
  dplyr::filter(type == "antigen") %>%
      dplyr::left_join(virus, 
              by = c("identifier" = "analysis_name")) %>%
  ggplot2::ggplot() +
      ggplot2::geom_point(data = subset(map_df, 
                               type == "sera"), 
                 aes(x = V1, 
                     y = V2,
                     color = age)) +
      ggplot2::geom_point(aes(x = V1, 
                     y = V2),
                 color = "red") +
      ggrepel::geom_label_repel(aes(x = V1, y = V2, label = short_name), max.overlaps = 17, size = 2.5) +
      ggplot2::labs(title = "H3N2 virus and human sera antigenic map\nwith pre-vaccination sera from all individuals", 
           subtitle = paste0("Stress = ", round(map$optimizations[[1]]$stress[1], digits = 2)),
           caption = "2 dimensions; 100 optimizations\nUnderconstrained sera and antigens were removed prior to map creation\nStandard dose individuals only") +
      ggplot2::xlab("Antigenic Distance Unit") +
      ggplot2::ylab("Antigenic Distance Unit") #+
      #ggplot2::xlim(c(-8, 5.5)) +
      #ggplot2::ylim(c(-5.5, 5.5)))

```

## Post Vaccination

```{r 2d-antigen}

map <- Racmacs::realignMap(map = Racmacs::read.acmap(filename = here::here(paste0("data/processed/", 
                                                                   subtype, 
                                                                   "_maps/", 
                                                                   subtype, 
                                                                   "_post_sd_2d.ace"))),
                           target_map = Racmacs::read.acmap(filename = here::here(paste0("data/processed/", 
                                                                   subtype, 
                                                                   "_maps/", 
                                                                   subtype, 
                                                                   "_pre_sd_2d.ace"))))

map_df <- AcmapToDF(map, MergeWithKey = TRUE, key)

map_post <- map_df

antigen_map <- map_df %>%
  dplyr::select("V1", "V2", "identifier", "type") %>%
    dplyr::filter(type == "antigen") %>%
          dplyr::left_join(virus, 
              by = c("identifier" = "analysis_name")) %>%
  ggplot2::ggplot(aes(x = V1, 
             y = V2, 
             label = short_name)) +
      ggplot2::geom_point() +
      ggrepel::geom_label_repel(size = 3,
                       alpha = 0.75) +
  ggplot2::theme_bw()+
      ggplot2::labs(title = "H1N1", 
           caption = paste0("Stress = ", round(map$optimizations[[1]]$stress[1], digits = 2))) +
      ggplot2::xlab("Antigenic Distance Unit") +
      ggplot2::ylab("Antigenic Distance Unit") # +
  #ggplot2::scale_y_continuous(breaks=seq(-3, 3 ,1),
  #                   limits = c(-3, 3)) +
  #ggplot2::scale_x_continuous(breaks=seq(-4, 1 ,1),
  #                   limits = c(-4.5, 1.5))

saveRDS(antigen_map,
        file = here::here('data/processed/h3_maps/h3_cartography.rds'))

  
ggsave(filename = here::here(paste0("Results/figures/", 
                                    subtype, 
                                    "/", 
                                    subtype, 
                                    "_post_sd_2d_antigens.png")), 
       plot = antigen_map, 
       width = 6)
  
```

```{r}
base::subset(map_post, 
       type == "antigen") %>%
  dplyr::left_join(subset(map_pre,
                   type == "antigen"),
            by = "identifier") %>%
  dplyr::select(V1.x, V2.x, identifier, V1.y, V2.y) %>%
  ggplot2::ggplot(aes(x = V1.y, y = V2.y))+
  ggplot2::geom_point() +
  ggplot2::geom_segment(aes(xend = V1.x, yend = V2.x),
               arrow = arrow())

b <- Racmacs::procrustesMap(comparison_map = Racmacs::read.acmap(filename = here::here(paste0("data/processed/", 
                                                                   subtype, 
                                                                   "_maps/", 
                                                                   subtype, 
                                                                   "_post_sd_2d.ace"))),
                           map = Racmacs::read.acmap(filename = here::here(paste0("data/processed/", 
                                                                   subtype, 
                                                                   "_maps/", 
                                                                   subtype, 
                                                                   "_pre_sd_2d.ace"))),
                           sera = FALSE)

tibble::as_tibble(b$optimizations[[1]]$procrustes$ag_coords) %>%
  ggplot2::ggplot(aes(x = V1, y = V2)) +
  ggplot2::geom_point()

a <- Racmacs::procrustesData(map = Racmacs::read.acmap(filename = here::here(paste0("data/processed/", 
                                                                   subtype, 
                                                                   "_maps/", 
                                                                   subtype, 
                                                                   "_post_sd_2d.ace"))),
                           comparison_map = Racmacs::read.acmap(filename = here::here(paste0("data/processed/", 
                                                                   subtype, 
                                                                   "_maps/", 
                                                                   subtype, 
                                                                   "_pre_sd_2d.ace"))))

#Racmacs::view(b)
```


```{r 2d-sera-antigen}

(post_sr_ag <- map_df %>%
  dplyr::filter(type == "antigen") %>%
      dplyr::left_join(virus, 
              by = c("identifier" = "analysis_name")) %>%
  ggplot2::ggplot() +
      ggplot2::geom_point(data = subset(map_df, 
                               type == "sera"), 
                 aes(x = V1, 
                     y = V2,
                     color = age)) +
      ggplot2::geom_point(aes(x = V1, 
                     y = V2),
                 color = "red") +
      ggrepel::geom_label_repel(aes(x = V1, y = V2, label = short_name), max.overlaps = 17, size = 2.5) +
      ggplot2::labs(title = "H3N2 virus and human sera antigenic map\nwith post-vaccination sera from all individuals", 
           subtitle = paste0("Stress = ", round(map$optimizations[[1]]$stress[1], digits = 2)),
           caption = "2 dimensions; 100 optimizations\nUnderconstrained sera and antigens were removed prior to map creation\nStandard dose individuals only") +
      ggplot2::xlab("Antigenic Distance Unit") +
      ggplot2::ylab("Antigenic Distance Unit")) # +
      #ggplot2::xlim(c(-8, 5.5)) +
      #ggplot2::ylim(c(-5.5, 5.5)))


  ggsave(filename = here::here(paste0("Results/figures/", 
                                      subtype, 
                                      "/", 
                                      subtype, 
                                      "_post_sd_2d_antigen_sera.png")), 
         plot = post_sr_ag, 
         width = 11)

  cowplot::plot_grid(pre_sr_ag, 
                     post_sr_ag, 
                     nrow = 1) %>%
  cowplot::ggsave2(filename = here::here(paste0("Results/figures/", 
                                                subtype, 
                                                "/", 
                                                subtype, 
                                                "_comp_sd_2d_antigen_sera.png")), 
                   width = 12, 
                   height = 6)

```



```{r}
h1 <- readRDS(file = here::here("data/processed/h1_maps/h1_cartography.rds"))
h3 <- readRDS(file = here::here("data/processed/h3_maps/h3_cartography.rds"))

cowplot::plot_grid(h1, h3,
                   nrow = 1,
                   labels = "AUTO") %>%
  cowplot::ggsave2(filename = here::here("Results/figures/sd_post_maps.png"),
          width = 7,
          height = 4,
          scale = 1.5)
```
